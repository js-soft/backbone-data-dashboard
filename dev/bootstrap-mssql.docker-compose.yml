name: nmshd_bkb_data_dashboard_dev

services:
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    ports:
      - "${MSSQL_PORT}:1433/tcp"
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${MSSQL_PASSWORD}
    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "${MSSQL_PASSWORD}" -C -Q "SELECT 1" -b -o /dev/null
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 15s
  db-init:
    build:
      context: .
      dockerfile: ./Dockerfile
    depends_on:
      db:
        condition: service_healthy
    command: /db-init/load_bacpac.sh
    environment:
      - MSSQL_HOST=db
      - MSSQL_PORT=1433
      - MSSQL_USER=sa
      - MSSQL_PASSWORD=${MSSQL_PASSWORD?}
      - MSSQL_DB=${MSSQL_DB?}
    volumes:
      - type: bind
        source: ${MSSQL_DB_BACKUP_FILE?}
        target: /db-init/backup.bacpac
        read_only: true
